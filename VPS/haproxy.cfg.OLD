
# OLD conf; used on VPS-eu (ubuntu 18.04)

global

    log 127.0.0.1:2005 local2 debug


	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
	stats timeout 30s
	#user haproxy
	#group haproxy

	ca-base /etc/ssl/certs
	crt-base /etc/ssl/private

    #lua-load /etc/haproxy/compare.lua

defaults
	log	global
    #option  httplog
	#option	dontlognull
    timeout connect 5000
    timeout client  5000
    timeout server  5000

    option  log-health-checks
    retries 3

frontend fe_HTTP

#    # c1>>
#    bind *:8001-8021
#    bind *:8097-8106
#    # <<
#
#    # c2>>
#    bind *:8022-8024
#    bind *:8027-8034 
#    bind *:8044-8060
#    bind *:8070-8079 
#    bind *:8081-8086
#    bind *:8980
#    #<<
#
#    # c3>>
#    bind *:8400-8499
#    # <<
#
#    # c6>>
#    bind *:8107-8170
#    bind *:8321-8360
#    # <<
#
#    # c9
#    bind *:8700-8750
#
#    #c10
#    bind *:8751-8799
#
#
#    # c11
#    bind *:8900-8950
#    
#    #c13
#    bind *:8500-8520
#
#    #c16
#    bind *:8550-8569

    #all
    bind *:8001-8999

    mode tcp
    default_backend bk_2
    tcp-request inspect-delay 3s

    tcp-request content set-var(sess.dst_port_orig) dst_port
    tcp-request content set-var(sess.dst_port_new) dst_port,add(10000)
    
    tcp-request content set-dst-port var(sess.dst_port_new)
    log-format "client=%ci:%cp frontend=%ft backend=%si:%sp %B:%U retries=%rc dst_port_orig=%[var(sess.dst_port_orig)] dst_port_new=%[var(sess.dst_port_new)]"

{% if vps_socks5_udp == 1 %}
# no socks5 listeners
{% else %}
frontend fe_SOCKS5
#    # c1>>
#    bind *:5001-5021
#    bind *:5097-5106
#    # <<
#
#    # c2>>
#    bind *:5022-5024
#    bind *:5027-5034 
#    bind *:5044-5060
#    bind *:5070-5079 
#    bind *:5081-5086
#    bind *:5980
#    #<<
#
#    # c3>>
#    bind *:5400-5499
#    # <<
#
#    # c6>>
#    bind *:5107-5170
#    bind *:5321-5360
#    # <<
#
#    # c9
#    bind *:5700-5750
#
#    #c10
#    bind *:5751-5799
#
#    # c11
#    bind *:5900-5950
#
#    #c13
#    bind *:5500-5520
#
#    #c16
#    bind *:5550-5569


    #all
    bind *:5001-5999

    mode tcp
    default_backend bk_2
    tcp-request inspect-delay 3s

    tcp-request content set-var(sess.dst_port_orig) dst_port
    tcp-request content set-var(sess.dst_port_new) dst_port,add(10000)
    
    tcp-request content set-dst-port var(sess.dst_port_new)
    log-format "client=%ci:%cp frontend=%ft backend=%si:%sp %B:%U retries=%rc dst_port_orig=%[var(sess.dst_port_orig)] dst_port_new=%[var(sess.dst_port_new)]"
{% endif %}

backend bk_2
    mode tcp
    server bk1 127.0.0.1:0  send-proxy

